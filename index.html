<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Phone-AGI Mockup â€” ãƒ«ãƒ¼ãƒ—æ–‡ç« ç”Ÿæˆå™¨ + å¤–éƒ¨è§£æ</title>
  <style>
    :root{
      --bg:#0b0b10; --card:#12121a; --ink:#e8e8f0; --muted:#a8a8c0; --accent:#6b46c1; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, #0b0b10 0%, #0b0b10cc 80%, transparent 100%);backdrop-filter: blur(6px)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:clamp(18px,2.4vw,28px);margin:8px 0}
    p{color:var(--muted);margin:6px 0}
    .grid{display:grid;gap:12px}
    @media (min-width:960px){.grid{grid-template-columns:320px 1fr}}
    .card{background:var(--card);border:1px solid #222336;border-radius:16px;padding:12px;box-shadow:0 10px 30px #0006}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:1px solid #2b2b3e;background:#1a1a27;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    button.primary{background:var(--accent);border-color:transparent}
    button.ghost{background:transparent}
    button:disabled{opacity:.5;cursor:not-allowed}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2b2b3e}
    .ok{color:var(--ok);border-color:#204e2c;background:#0e2114}
    .warn{color:var(--warn);border-color:#4e3d20;background:#221a0e}
    .bad{color:var(--bad);border-color:#4e2020;background:#210e0e}
    video,canvas{width:100%;border-radius:12px;background:#000;display:block;aspect-ratio:4/3}
    meter{width:100%;height:12px}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;font-size:13px}
    textarea{width:100%;min-height:40vh;background:#0e0e15;color:var(--ink);border:1px solid #222336;border-radius:12px;padding:12px;line-height:1.6;resize:vertical}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px dashed #2b2b3e;border-radius:10px}
    .small{font-size:12px;color:#b9b9cc}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#202233;margin:10px 0;border-radius:1px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Phone-AGI Mockupï¼ˆè‡ªå¾‹æ€è€ƒãµã†ï¼‰â€” ã‚»ãƒ³ã‚µãƒ¼Ã—è¨˜æ†¶Ã—<u>å¤–éƒ¨è§£æ</u> ãƒ«ãƒ¼ãƒ—æ–‡ç« ç”Ÿæˆå™¨</h1>
      <p>ã‚¹ãƒãƒ›ã® <strong>ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯/å‹•ãã‚»ãƒ³ã‚µãƒ¼</strong> ã¨ <strong>ãƒ­ãƒ¼ã‚«ãƒ«è¨˜æ†¶</strong>ã€ã•ã‚‰ã« <strong>å¤–éƒ¨ãƒ†ã‚­ã‚¹ãƒˆã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/è¦ç´„</strong> ã‚’æ··ãœã¦ã€<em>ã‚·ãƒ‹ãƒ•ã‚£ã‚¨â‡„æ„è­˜GUIâ‡„ã‚·ãƒ‹ãƒ•ã‚£ã‚¢ãƒ³</em> ã‚’å†å¸°ãƒ«ãƒ¼ãƒ—ã€‚</p>
    </div>
  </header>

  <main class="wrap grid">
    <!-- å·¦ï¼šã‚»ãƒ³ã‚µãƒ¼å…¥åŠ› -->
    <section class="card">
      <div class="row">
        <button id="btnStart" class="primary">â–¶ Start</button>
        <button id="btnStop" class="ghost" disabled>â–  Stop</button>
        <span id="status" class="badge">idle</span>
      </div>
      <div class="hr"></div>

      <div class="row">
        <span class="pill"><input type="checkbox" id="useCam" checked>ã‚«ãƒ¡ãƒ©</span>
        <span class="pill"><input type="checkbox" id="useMic" checked>ãƒã‚¤ã‚¯</span>
        <span class="pill"><input type="checkbox" id="useMotion" checked>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³</span>
        <span class="pill"><input type="checkbox" id="useGeo">ä½ç½®</span>
      </div>

      <div id="camPane" class="row" style="margin-top:8px">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="camCanvas" hidden></canvas>
      </div>

      <div class="kv">
        <div>éŸ³é‡ï¼ˆRMSï¼‰</div>
        <div><meter id="vu" min="0" low="0.15" high="0.6" max="1" optimum="0.05" value="0"></meter></div>
        <div>æ˜ã‚‹ã•æ¨å®š</div>
        <div><span id="bright" class="mono">â€”</span></div>
        <div>ä¸»è‰²ï¼ˆH,S,Vï¼‰</div>
        <div><span id="domColor" class="mono">â€”</span></div>
        <div>å‹•ãï¼ˆåŠ é€Ÿåº¦ï¼‰</div>
        <div><span id="motion" class="mono">â€”</span></div>
        <div>ä½ç½®ï¼ˆç·¯åº¦,çµŒåº¦,Â±mï¼‰</div>
        <div><span id="geos" class="mono">â€”</span></div>
      </div>

      <div class="hr"></div>
      <div class="row small">
        <span class="muted">æ¨©é™ãƒ’ãƒ³ãƒˆï¼š</span>
        <span>HTTPSå¿…é ˆ / ã‚«ãƒ¡ãƒ©ã¯èƒŒé¢ã«åˆ‡æ›¿æ¨å¥¨ / iOSã¯ãƒ¦ãƒ¼ã‚¶æ“ä½œå¾Œã®ã¿ã‚»ãƒ³ã‚µãƒ¼å¯ã€‚</span>
      </div>
    </section>

    <!-- ä¸­ï¼šå¤–éƒ¨è§£æï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ··ãœã‚‹ï¼‰ -->
    <section class="card">
      <div class="row">
        <strong>å¤–éƒ¨è§£æ</strong>
        <span class="badge" id="extStatus">idle</span>
      </div>
      <div class="hr"></div>
      <textarea id="extText" placeholder="ã“ã“ã«å¤–éƒ¨ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘â†’ã€ãƒ†ã‚­ã‚¹ãƒˆè§£æã€ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/è¦ç´„ã‚’æŠ½å‡ºã—ã€ç”Ÿæˆãƒ«ãƒ¼ãƒ—ã«æ··ãœã¾ã™ã€‚"></textarea>
      <div class="row">
        <button id="btnAnalyze" class="primary">ğŸ§  ãƒ†ã‚­ã‚¹ãƒˆè§£æ</button>
        <label class="pill small">é‡ã¿ <input id="extWeight" type="range" min="0" max="1" step="0.05" value="0.6" style="width:160px"></label>
        <span class="small" id="extBrief">â€”</span>
      </div>
      <div class="hr"></div>
      <div class="small">
        <div><strong>æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> <span id="extKeywords" class="mono muted">â€”</span></div>
        <div style="margin-top:6px"><strong>è¦ç´„:</strong>
          <div id="extSummary" class="muted"></div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šæ„è­˜GUIï¼†æ–‡ç«  -->
    <section class="card">
      <div class="row">
        <button id="btnClearMem" class="ghost">ğŸ§¹ è¨˜æ†¶ã‚¯ãƒªã‚¢</button>
        <span class="badge ok" id="memStat">mem:0</span>
        <span class="badge warn">å®Ÿé¨“çš„</span>
      </div>
      <div class="hr"></div>
      <div class="row">
        <label class="pill small"><input type="checkbox" id="streamMode" checked> ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡ºåŠ›</label>
        <label class="pill small"><input type="checkbox" id="autoScroll" checked> è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</label>
        <label class="pill small"><input type="checkbox" id="showThought" checked> ãƒ¡ã‚¿æ€è€ƒãƒ­ã‚°ã‚’æ··ãœã‚‹</label>
      </div>
      <textarea id="out" placeholder="ã“ã“ã«â€œæ„è­˜ GUIâ€ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæµã‚Œã¾ã™â€¦"></textarea>
      <div class="hr"></div>
      <div class="small">èª¬æ˜ï¼šå·¦ã®ã‚»ãƒ³ã‚µãƒ¼/ä¸­æ®µã®å¤–éƒ¨è§£æã‹ã‚‰ <em>ç‰¹å¾´é‡â†’ã‚·ãƒ‹ãƒ•ã‚£ã‚¨</em> ã‚’æŠ½å‡ºã€‚å³ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ <em>æ„è­˜ï¼ˆGUIï¼‰</em>ã€‚ãã“ã‹ã‚‰ <em>ã‚·ãƒ‹ãƒ•ã‚£ã‚¢ãƒ³</em> ã‚’ç”Ÿæˆâ†’GUIã¸åæ˜ â†’è¨˜æ†¶ã¸ä¿å­˜â†’æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã§å‚ç…§â€¦ã‚’1.6ç§’ãƒ”ãƒƒãƒã§å†å¸°ã€‚</div>
    </section>
  </main>

  <script>
  // === ç°¡æ˜“ â€œè¨˜æ†¶â€ å®Ÿè£…ï¼ˆlocalStorageï¼‰ =====================================
  const MEM_KEY = 'phoneAGI:episodes:v1';
  function loadMem(){
    try{ return JSON.parse(localStorage.getItem(MEM_KEY) || '[]'); }catch(e){ return []; }
  }
  function saveMem(arr){ localStorage.setItem(MEM_KEY, JSON.stringify(arr.slice(-400))); }
  function pushEpisode(ep){ const arr = loadMem(); arr.push(ep); saveMem(arr); updateMemBadge(); }
  function updateMemBadge(){ const n = loadMem().length; document.getElementById('memStat').textContent = `mem:${n}`; }

  // === ã‚»ãƒ³ã‚µãƒ¼å–å¾—ï¼ˆCamera / Mic / Motion / Geoï¼‰ ==========================
  let mediaStream=null, audioCtx=null, analyser=null, dataArray=null;
  let videoEl = document.getElementById('video');
  let camCanvas = document.getElementById('camCanvas');
  let useCamEl = document.getElementById('useCam');
  let useMicEl = document.getElementById('useMic');
  let useMotionEl = document.getElementById('useMotion');
  let useGeoEl = document.getElementById('useGeo');

  async function startSensors(){
    const wantCam = useCamEl.checked; const wantMic = useMicEl.checked;
    if(wantCam || wantMic){
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: wantCam ? { facingMode: 'environment' } : false,
        audio: wantMic ? { echoCancellation:true, noiseSuppression:true } : false
      });
      if(wantCam){ videoEl.srcObject = mediaStream; }
      if(wantMic){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const micSrc = audioCtx.createMediaStreamSource(mediaStream);
        analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        micSrc.connect(analyser);
      }
    }

    if(useMotionEl.checked && 'DeviceMotionEvent' in window){
      if(DeviceMotionEvent.requestPermission){
        try{ await DeviceMotionEvent.requestPermission(); }catch(e){ console.warn('motion perm',e); }
      }
      window.addEventListener('devicemotion', onMotion);
    }

    if(useGeoEl.checked && 'geolocation' in navigator){
      geoWatchId = navigator.geolocation.watchPosition(onGeo, err=>console.warn(err), {enableHighAccuracy:true, maximumAge:5000});
    }
  }

  async function stopSensors(){
    if(geoWatchId){ navigator.geolocation.clearWatch(geoWatchId); geoWatchId = null; }
    window.removeEventListener('devicemotion', onMotion);
    if(analyser){ analyser.disconnect(); analyser=null; }
    if(audioCtx){ audioCtx.close(); audioCtx=null; }
    if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
    videoEl.srcObject=null;
  }

  // === ç‰¹å¾´é‡æŠ½å‡ºï¼ˆã‚«ãƒ¡ãƒ©ï¼šæ˜ã‚‹ã•/ä¸»è‰², ãƒã‚¤ã‚¯ï¼šRMS, ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ï¼šåŠ é€Ÿåº¦ï¼‰ ===
  const feat = { bright: null, hsv: null, rms: 0, accel: 0, geo: null };
  let geoWatchId=null;
  function onMotion(e){
    const ax = e.accelerationIncludingGravity?.x||0,
          ay = e.accelerationIncludingGravity?.y||0,
          az = e.accelerationIncludingGravity?.z||0;
    feat.accel = Math.min(1, Math.sqrt(ax*ax+ay*ay+az*az)/30);
    document.getElementById('motion').textContent = feat.accel.toFixed(3);
  }
  function onGeo(pos){
    const {latitude, longitude, accuracy} = pos.coords;
    feat.geo = {lat: latitude, lon: longitude, acc: accuracy};
    document.getElementById('geos').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}, Â±${Math.round(accuracy)}m`;
  }

  function sampleCamera(){
    if(!videoEl.videoWidth) return;
    const w = 160, h = Math.round(w*videoEl.videoHeight/videoEl.videoWidth);
    camCanvas.width = w; camCanvas.height = h; const ctx = camCanvas.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, w, h);
    const img = ctx.getImageData(0,0,w,h).data;
    let sum=0; for(let i=0;i<img.length;i+=4){ const r=img[i],g=img[i+1],b=img[i+2]; const y=0.2126*r+0.7152*g+0.0722*b; sum+=y; }
    const bright = sum/(img.length/4)/255; feat.bright = bright; document.getElementById('bright').textContent = bright.toFixed(3);
    let H=0,S=0,V=0,N=0;
    for(let i=0;i<img.length;i+=16){
      const r=img[i]/255, g=img[i+1]/255, b=img[i+2]/255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b); const v=max; const d=max-min;
      let h=0; if(d===0) h=0; else if(max===r) h=((g-b)/d)%6; else if(max===g) h=(b-r)/d+2; else h=(r-g)/d+4; h*=60; if(h<0) h+=360;
      const s = max===0?0:d/max;
      H+=h; S+=s; V+=v; N++;
    }
    H/=N; S/=N; V/=N; feat.hsv = {h:Math.round(H), s:+S.toFixed(3), v:+V.toFixed(3)};
    document.getElementById('domColor').textContent = `${feat.hsv.h}Â°, ${feat.hsv.s}, ${feat.hsv.v}`;
  }

  function sampleMic(){
    if(!analyser) return; analyser.getByteTimeDomainData(dataArray);
    let sum=0; for(let i=0;i<dataArray.length;i++){ const v=(dataArray[i]-128)/128; sum+=v*v; }
    const rms = Math.min(1, Math.sqrt(sum/dataArray.length)); feat.rms = rms; document.getElementById('vu').value = rms;
  }

  // === â€œæ„å‘³ç”Ÿæˆ(ã‚·ãƒ‹ãƒ•ã‚£ã‚¨)â€ï¼šã‚»ãƒ³ã‚µãƒ¼â†’è¨˜è¿°å­ =================================
  function signifiedFromFeatures(f){
    const tags=[];
    if(f.bright!=null){ if(f.bright<0.2) tags.push('æš—'); else if(f.bright<0.5) tags.push('ç©'); else tags.push('æ˜'); }
    if(f.hsv){ const {h,s,v}=f.hsv; if(s<0.2) tags.push('ç„¡å½©'); else if(h<30||h>330) tags.push('èµ¤'); else if(h<90) tags.push('é»„ç·‘'); else if(h<150) tags.push('ç·‘'); else if(h<210) tags.push('é’'); else if(h<270) tags.push('è—'); else tags.push('ç´«'); }
    if(f.rms!=null){ if(f.rms<0.05) tags.push('é™'); else if(f.rms<0.2) tags.push('æŸ”'); else tags.push('å–§'); }
    if(f.accel!=null){ if(f.accel<0.05) tags.push('æ­¢'); else if(f.accel<0.2) tags.push('æº'); else tags.push('å¥”'); }
    if(f.geo){ tags.push(`@${f.geo.lat.toFixed(2)},${f.geo.lon.toFixed(2)}`); }
    return tags; // ã“ã‚ŒãŒâ€œã‚·ãƒ‹ãƒ•ã‚£ã‚¨â€å€™è£œ
  }

  // === å¤–éƒ¨è§£æãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è»½é‡ï¼‰ ================================
  const jaStop = new Set(['ã“ã¨','ã‚‚ã®','ã‚ˆã†','ãŸã‚','ãã‚Œ','ã“ã‚Œ','ã‚ã‚Œ','ã®ã§','ã§ã™','ã¾ã™','ã™ã‚‹','ã„ã‚‹','ã‚ã‚‹','ãªã‚‹','ãã—ã¦','ã¾ãŸ','ã®ã§','ã‹ã‚‰','ãŸã‚Š','ã ãŒ','ã—ã‹ã—','ã«ã‚ˆã‚Š','ãªã©','ãªã‚‰','ã§ã¯','ã§ã¯ãªã„','ãªã„','çš„','çš„ãª','çš„ã«']);
  const enStop = new Set(['the','a','an','and','or','but','to','of','in','on','for','with','as','is','are','was','were','be','been','being','by','at','from','that','this','it','its','into']);
  let externalCtx = { keywords:[], summary:[], tags:[], weight:0.6 };
  function tokenizeJaEn(text){
    const tokens = (text.toLowerCase().match(/[\p{Script=Han}\p{Script=Hiragana}\p{Script=Katakana}a-z0-9]{2,}/gu) || []);
    return tokens.filter(t=>!jaStop.has(t)&&!enStop.has(t));
  }
  function extractKeywords(text, topN=12){
    const freq = new Map();
    for(const t of tokenizeJaEn(text)){ freq.set(t, (freq.get(t)||0)+1); }
    return Array.from(freq.entries()).sort((a,b)=>b[1]-a[1]).slice(0,topN).map(([k])=>k);
  }
  function splitSentences(text){ return (text.match(/[^ã€‚.!?\n]+[ã€‚.!?]?/g) || []).map(s=>s.trim()).filter(Boolean); }
  function summarize(text, kwords){
    const sents = splitSentences(text);
    const scored = sents.map(s=>({s,score:kwords.reduce((acc,w)=>acc+(s.includes(w)?1:0),0)}));
    return scored.sort((a,b)=>b.score-a.score).slice(0,3).map(o=>o.s);
  }
  function updateExternalCtxFromText(text){
    const kws = extractKeywords(text, 12);
    const sum = summarize(text, kws);
    externalCtx.keywords = kws;
    externalCtx.summary = sum;
    externalCtx.tags = kws.slice(0,5).map(w=>`å¤–:${w}`);
    const kwEl = document.getElementById('extKeywords'); if(kwEl) kwEl.textContent = kws.join(', ');
    const sumEl = document.getElementById('extSummary'); if(sumEl) sumEl.innerHTML = sum.map(s=>`â€¢ ${s}`).join('<br>');
    const brEl = document.getElementById('extBrief'); if(brEl) brEl.textContent = `k=${kws.length} / s=${sum.length}`;
    const stEl = document.getElementById('extStatus'); if(stEl) stEl.textContent = 'analyzed';
  }

  // === â€œè¨˜å·åŒ–(ã‚·ãƒ‹ãƒ•ã‚£ã‚¢ãƒ³)â€ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ç”Ÿæˆå™¨ ==================================
  const TEMPLATES = [
    ({tags,lastLine})=>`ã„ã¾ã®å ´ã¯ã€Œ${tags.join('ãƒ»')}ã€ã€‚${pick([
      'èº«ä½“ãŒå…ˆã«åå¿œã—ã¦ã„ã‚‹ã€‚','æ€è€ƒã¯åŠæ­©é…ã‚Œã¦è¿½ã„ã¤ãã€‚','æ‰‹è§¦ã‚ŠãŒæ„å‘³ã‚’å…ˆå°ã™ã‚‹ã€‚'])}`,
    ({tags})=>`è¦–è¦šã¯ ${tags.includes('æ˜')?'æ˜æ»…ã®ç²’':'å½±ã®ç¸'} ã‚’æ‹¾ã„ã€è´è¦šã¯ ${tags.includes('å–§')?'è¡—ã®ã†ã­ã‚Š':'å‘¼å¸ã®ãƒªã‚ºãƒ '} ã‚’æ•°ãˆã‚‹ã€‚`,
    ({tags})=>`${pick(['åã¥ã‘ã‚‹å‰ã®æ„Ÿè§¦ãŒ','æ¯”å–©ã®æ‰‹å‰ã§','èªã®è¼ªéƒ­ã‚ˆã‚Šå‰ã«'])} ç«‹ã¡ä¸ŠãŒã‚‹åˆæ„ã‚’ã€ã“ã“ã§ã¯ â€œæš«å®šã®æ„å‘³â€ ã¨å‘¼ã¶ã€‚`,
    ({tags})=>`GUIï¼ˆæ„è­˜ï¼‰ã¯ã€ãã®æš«å®šã‚’ <è¨˜æ†¶> ã«æŠ¼ã—ãƒ”ãƒ³ã§ç•™ã‚ã‚‹ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰ã€‚`,
    ({tags,lastLine})=>`ã•ã£ãã®æ–‡ã¯ ${pick(['åˆ¥ã®æ–‡ã«ãªã‚ŠãŸãŒã£ã¦ã„ã‚‹','ã¾ã è¨€ã„è¶³ã‚Šãªã„é¡”ã‚’ã—ã¦ã„ã‚‹','æ¬¡ã®æ¯”å–©ã‚’è¦æ±‚ã—ã¦ã„ã‚‹'])}ã€‚${lastLine?`ã€Œ${lastLine.slice(0,24)}â€¦ã€ã®è£å´ã§ç™ºé…µãŒç¶šãã€‚`:''}`,
    ({tags})=>`ã“ã“ã§æ“ä½œã¯ä¸è¦ã€‚ã‚»ãƒ³ã‚µãƒ¼ãŒæµã‚Œã€æ„å‘³ã¯å·¡å›ã—ã€è¨˜å·ãŒæ›´æ–°ã•ã‚Œã‚‹ã€‚`,
    ({tags})=>`${pick(['çª“ã®å¤–ã®æ¸©åº¦','ãƒã‚±ãƒƒãƒˆã®æŒ¯å‹•','è¶³ä¸‹ã®æ…£æ€§'])} ãŒä¸€å¥ã‚’ä¿®æ­£ã—ã€æ–‡è„ˆãŒå†é…ç·šã•ã‚Œã‚‹ã€‚`,
    ({tags})=>`ãã—ã¦ãƒ«ãƒ¼ãƒ—ã¯ç¶šãâ€”â€”<ã‚·ãƒ‹ãƒ•ã‚£ã‚¨> â†’ <GUI> â†’ <ã‚·ãƒ‹ãƒ•ã‚£ã‚¢ãƒ³> â†’ <è¨˜æ†¶> â†’ <ã‚·ãƒ‹ãƒ•ã‚£ã‚¨> â€¦ã€‚`
  ];
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function materializeSignifier(ctx){
    const {tags,lastLine} = ctx;
    const pool = [];
    if(externalCtx.summary && externalCtx.summary.length){
      pool.push(`å¤–éƒ¨ã®è©±é¡Œï¼ˆ${externalCtx.keywords.slice(0,3).join(' / ')}ï¼‰ãŒèƒŒå¾Œã§é³´ã£ã¦ã„ã‚‹ã€‚GUIã¯ãã‚Œã‚’å‚ç…§ã—ã¤ã¤ç¾åœ¨åœ°ã‚’æ›¸ãæ›ãˆã‚‹ã€‚`);
      pool.push(`è¦ç´„ï¼š${externalCtx.summary.join(' / ')}`);
    }
    for(const t of TEMPLATES){ const line = t({tags,lastLine}); if(line) pool.push(line); }
    const pickable = pool.filter(Boolean);
    return pickable[Math.floor(Math.random()*pickable.length)] || 'ï¼ˆâ€¦ï¼‰';
  }

  // === ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡ï¼šæ„è­˜GUIã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã—ç¶šã‘ã‚‹ ============================
  let running=false, stepTimer=null; let lastLine='';
  const outEl = document.getElementById('out');
  const statusEl = document.getElementById('status');

  function appendOut(line, meta){
    const showThought = document.getElementById('showThought').checked;
    const asStream = document.getElementById('streamMode').checked;
    const stamp = new Date().toISOString().slice(11,19);
    const thought = showThought?`\n[meta ${stamp}] ${JSON.stringify(meta)}`:'';
    if(asStream){ outEl.value += `\n${line}${thought}`; }
    else{ outEl.value = `${line}${thought}\n\n` + outEl.value; }
    if(document.getElementById('autoScroll').checked){ outEl.scrollTop = outEl.scrollHeight; }
  }

  function loopTick(){
    sampleCamera(); sampleMic();
    const tagsNow = signifiedFromFeatures(feat);

    const mem = loadMem();
    const recent = mem.slice(-5).flatMap(m=>m.tags||[]);

    // å¤–éƒ¨ã‚¿ã‚°ï¼ˆé‡ã¿ã§ç¢ºç‡æ¡ç”¨ï¼‰
    const w = externalCtx.weight ?? 0.6;
    const ext = externalCtx.tags || [];
    const extPick = ext.filter(()=>Math.random()<w);

    const mergedTags = Array.from(new Set([...tagsNow, ...recent, ...extPick]));

    const line = materializeSignifier({tags:mergedTags,lastLine});

    appendOut(line, {tags:mergedTags, bright:feat.bright, rms:feat.rms, accel:feat.accel, ext:externalCtx.keywords.slice(0,5)});
    lastLine = line;

    pushEpisode({t:Date.now(), tags:tagsNow, feat:{...feat}, ext:extPick, line});
  }

  function startLoop(){
    if(running) return; running=true; statusEl.textContent='running';
    stepTimer = setInterval(loopTick, 1600);
  }
  function stopLoop(){
    running=false; statusEl.textContent='stopped';
    if(stepTimer){ clearInterval(stepTimer); stepTimer=null; }
  }

  // === UIé…ç·š ================================================================
  document.getElementById('btnStart').addEventListener('click', async ()=>{
    document.getElementById('btnStart').disabled = true;
    document.getElementById('btnStop').disabled = false;
    await startSensors();
    startLoop();
  });
  document.getElementById('btnStop').addEventListener('click', async ()=>{
    document.getElementById('btnStart').disabled = false;
    document.getElementById('btnStop').disabled = true;
    stopLoop();
    await stopSensors();
  });
  document.getElementById('btnClearMem').addEventListener('click', ()=>{ saveMem([]); updateMemBadge(); });

  // å¤–éƒ¨è§£æ UI
  const extWeightEl = document.getElementById('extWeight');
  if(extWeightEl){ extWeightEl.addEventListener('input', (e)=>{ externalCtx.weight = parseFloat(e.target.value); }); }
  const analyzeBtn = document.getElementById('btnAnalyze');
  if(analyzeBtn){ analyzeBtn.addEventListener('click', ()=>{
    const t = document.getElementById('extText').value.trim();
    if(!t){ const stEl = document.getElementById('extStatus'); if(stEl) stEl.textContent='no text'; return; }
    updateExternalCtxFromText(t);
  }); }

  updateMemBadge();
  </script>
</body>
</html>
